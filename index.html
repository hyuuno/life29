<!DOCTYPE html>
<html lang="zh-CN" data-bg="gray">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life29 · 我们的世界</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Noto+Serif+SC:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E🎄%3C/text%3E%3C/svg%3E">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        #globeContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        #globeContainer canvas {
            outline: none;
        }
    </style>
</head>
<body>
    <div class="noise-overlay"></div>
    
    <header class="header">
        <div class="logo">
            <span class="logo-text">Life</span>
            <span class="logo-number">29</span>
        </div>
        <nav class="nav">
            <div class="nav-dropdown" id="globeDropdown">
                <button class="nav-link active" id="globeNavBtn">
                    地球
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
                <div class="nav-dropdown-menu" id="globeMenu">
                    <div class="dropdown-label">归位城市</div>
                    <div class="city-options" id="homeCityOptions"></div>
                </div>
            </div>
            <a href="#" class="nav-link" data-view="timeline">时间线</a>
            <a href="#" class="nav-link" data-view="memories">回忆</a>
            <a href="schedule.html" class="nav-link">做咩</a>
            <a href="music.html" class="nav-link">Music</a>
            <a href="relax.html" class="nav-link">Relax</a>
        </nav>
        <div class="header-actions">
            <div class="cloud-status disconnected" id="cloudStatus" title="云端状态">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
                </svg>
                <span class="cloud-status-dot"></span>
            </div>
            <div class="map-level-dropdown" id="mapLevelDropdown">
                <button class="btn-icon map-level-btn" id="mapLevelBtn" title="地图详细度">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
                        <line x1="8" y1="2" x2="8" y2="18"></line>
                        <line x1="16" y1="6" x2="16" y2="22"></line>
                    </svg>
                </button>
                <div class="dropdown-menu map-level-menu" id="mapLevelMenu">
                    <div class="dropdown-label">地图详细度</div>
                    <button class="dropdown-item active" data-level="country">
                        <span class="level-icon">🌍</span><span class="level-name">国家轮廓</span>
                    </button>
                    <button class="dropdown-item" data-level="province">
                        <span class="level-icon">🗺️</span><span class="level-name">省份/州</span>
                    </button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" data-level="none">
                        <span class="level-icon">○</span><span class="level-name">仅标记点</span>
                    </button>
                </div>
            </div>
            <div class="bg-color-picker" id="bgColorPicker">
                <button class="bg-color-btn active" data-bg="gray" title="灰色"></button>
                <button class="bg-color-btn" data-bg="pink" title="粉色"></button>
                <button class="bg-color-btn" data-bg="warm" title="暖色"></button>
                <button class="bg-color-btn" data-bg="blue" title="蓝色"></button>
            </div>
            <button class="btn-icon theme-toggle" id="themeToggle" title="切换主题">
                <svg class="icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="5"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg>
                <svg class="icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
            <button class="btn-icon" id="searchBtn" title="搜索">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
            </button>
            <div class="user-dropdown" id="userDropdown">
                <button class="btn-icon user-btn" id="userBtn" title="选择用户">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                </button>
                <div class="dropdown-menu" id="userMenu">
                    <div class="dropdown-label">选择用户</div>
                    <button class="dropdown-item user-wiwi" data-user="wiwi"><span class="user-avatar">W</span><span class="user-name">wiwi</span></button>
                    <button class="dropdown-item user-yuyu" data-user="yuyu"><span class="user-avatar">Y</span><span class="user-name">yuyu</span></button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item logout-btn" id="logoutBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        <span>退出登录</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <div id="globeContainer" class="globe-container"></div>
        
        <aside class="side-panel left-panel">
            <div class="panel-content">
                <h2 class="panel-title">我们去过的地方</h2>
                <p class="panel-subtitle">每一个足迹，都是爱的证明</p>
                <div class="stats">
                    <div class="stat-item"><span class="stat-number" id="totalCities">0</span><span class="stat-label">城市</span></div>
                    <div class="stat-item"><span class="stat-number" id="totalPhotos">0</span><span class="stat-label">照片</span></div>
                    <div class="stat-item"><span class="stat-number" id="totalJournals">0</span><span class="stat-label">日志</span></div>
                </div>
            </div>
        </aside>

        <div id="cityPreview" class="city-preview hidden">
            <div class="preview-header">
                <h3 class="preview-city"></h3>
                <span class="preview-country"></span>
            </div>
            <div class="preview-stats">
                <span class="preview-photos"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><path d="m21 15-5-5L5 21"></path></svg><span class="count">0</span> 张照片</span>
                <span class="preview-journals"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"></path></svg><span class="count">0</span> 篇日志</span>
            </div>
            <div class="preview-hint">点击查看详情</div>
        </div>
    </main>

    <div id="cityListPanel" class="city-list-panel">
        <div class="city-list-header">
            <h3>所有城市</h3>
            <button class="btn-close" id="closeCityList"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 6 6 18M6 6l12 12"></path></svg></button>
        </div>
        <div class="city-list-search"><input type="text" placeholder="搜索城市..." id="citySearch"></div>
        <div class="city-list" id="cityList"></div>
    </div>

    <button id="addMomentBtn" class="fab hidden" title="记录新Moment">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"></path></svg>
    </button>

    <div id="addMomentModal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <button class="modal-close" id="closeMomentModal"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 6 6 18M6 6l12 12"></path></svg></button>
            
            <div id="momentStep1" class="moment-step">
                <div class="modal-steps">
                    <span class="step-dot active"></span>
                    <span class="step-dot"></span>
                </div>
                <div class="modal-header">
                    <h2>记录新Moment</h2>
                    <p>选择这个瞬间发生的地点</p>
                </div>
                <form id="momentLocationForm" class="modal-form">
                    <div class="form-group">
                        <label for="momentCountry">国家</label>
                        <select id="momentCountry" required>
                            <option value="">选择国家...</option>
                            <option value="中国">中国</option>
                            <option value="美国">美国</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="momentCity">城市</label>
                        <select id="momentCity" required disabled>
                            <option value="">先选择国家...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="momentDate">日期</label>
                        <input type="date" id="momentDate">
                    </div>
                    <button type="submit" class="btn-primary">下一步</button>
                </form>
            </div>
            
            <div id="momentStep2" class="moment-step" style="display: none;">
                <div class="modal-steps">
                    <span class="step-dot"></span>
                    <span class="step-dot active"></span>
                </div>
                <div class="modal-header">
                    <h2 id="momentCityTitle">记录这一刻</h2>
                    <p>写下想法，添加照片</p>
                </div>
                <form id="momentContentForm" class="modal-form">
                    <div class="form-group">
                        <textarea id="momentContent" placeholder="这一刻的想法..." rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label>照片</label>
                        <div class="photo-upload-area" id="photoUploadArea">
                            <button type="button" class="add-photo-btn" id="addPhotoBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 5v14M5 12h14"></path></svg>
                            </button>
                        </div>
                        <input type="file" id="photoFileInput" accept="image/*" multiple style="display: none;">
                    </div>
                    <div style="display: flex; gap: var(--space-md);">
                        <button type="button" class="btn-secondary" id="backToStep1">返回</button>
                        <button type="submit" class="btn-primary" style="flex: 1;">发表</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-left"><span class="user-status" id="userStatus">未登录</span></div>
        <div class="footer-center">
            <a href="music.html" class="footer-music-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                <span>Music</span>
            </a>
        </div>
        <div class="footer-right"><span class="footer-date" id="currentDate"></span></div>
    </footer>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="js/config.js"></script>
    <script src="js/cloudinary-service.js"></script>
    <script src="js/supabase-service.js"></script>
    <script src="js/global-music.js"></script>
    <script src="js/data.js"></script>
    <script src="js/globe.js"></script>
    <script src="js/app.js"></script>
</body>
</html>